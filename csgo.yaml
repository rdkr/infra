## template: jinja
#cloud-config 

fqdn: cs.rdkr.uk
hostname: cs.rdkr.uk

mounts:
  - [sda, /mnt]

users:
  - name: csgo
    homedir: /mnt/csgo
    lock_passwd: True
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

package_upgrade: true

write_files:
  - path: /etc/systemd/system/csgo.service
    owner: root:root
    content: |
      [Unit]
      Description=csgo
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=forking
      User=csgo
      WorkingDirectory=/mnt/csgo
      ExecStart=/mnt/csgo/csgoserver start
      ExecStop=/mnt/csgo/csgoserver stop
      Restart=no
      RemainAfterExit=yes
      
      [Install]
      WantedBy=multi-user.target

  - path: /etc/cron.d/csgo
    owner: root:root
    content: |
      * * * * * csgo wget -O /mnt/csgo/serverfiles/csgo/cfg/csgoserver.cfg https://raw.githubusercontent.com/rdkr/infra/master/csgo/server.cfg > /dev/null
      * * * * * csgo wget -O /mnt/csgo/serverfiles/csgo/addons/sourcemod/configs/admins_simple.ini https://raw.githubusercontent.com/rdkr/infra/master/csgo/admins_simple.ini > /dev/null
      * * * * * csgo ./csgoserver monitor > /dev/null

  - path: /root/lgsm.cfg
    owner: root:root
    content: |
      
      ip={{ ds.meta_data.interfaces.public[0].ipv4.ip_address }}
      
      gametype="0"
      gamemode="1"

      mapgroup="mg_active"
      defaultmap="de_mirage"

      maxplayers="10"
      tickrate="128"

      gslt="${csgo_gslt_token}"

      wsapikey="${csgo_web_token}"
      wscollectionid=""
      wsstartmap=""

      updateonstart="on"

runcmd:
  - su - csgo -c """wget --no-clobber -O linuxgsm.sh https://linuxgsm.sh && chmod +x linuxgsm.sh && bash linuxgsm.sh csgoserver"""
  - su - csgo -c """./csgoserver auto-install"""
  - cp /root/lgsm.cfg /mnt/csgo/lgsm/config-lgsm/csgoserver/csgoserver.cfg
  - chown -R csgo:csgo /mnt/csgo
  - systemctl enable csgo
  - systemctl start csgo